<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<meta name="theme-color" content="#070a0f"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="AWS問題集"/>
<title>AWS 問題集（PC版 Fix）</title>
<style>
:root {
  --bg0:#070a0f; --bg1:#0c121b; --panel:#101a26; --panel2:#0d1620;
  --line:#1a2a3a; --text:#e6eef7; --muted:#a9b6c5; --accent:#4ea1ff; --bad:#ff5a6b; --good:#52d27d;
  --btn:#122235;
}
*{box-sizing:border-box}
html{-webkit-text-size-adjust: 100%; text-size-adjust: 100%;}
body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;background:radial-gradient(1200px 800px at 50% -100px,#18283c 0%,var(--bg0) 55%,#000 100%);color:var(--text); -webkit-text-size-adjust: 100%; text-size-adjust: 100%;}
header{position:sticky;top:0;z-index:10;background:rgba(6,10,15,.78);backdrop-filter: blur(10px);border-bottom:1px solid rgba(255,255,255,.06);}
.topbar{max-width:1200px;margin:0 auto;padding:10px 12px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
select,button,input{font:inherit}
.sel{background:var(--panel2);color:var(--text);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px 12px;}
.btn{background:var(--btn);color:var(--text);border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:10px 14px;cursor:pointer}
.btn:hover{border-color:rgba(255,255,255,.22)}
.btn{ white-space:nowrap; }
.btn.primary{background:linear-gradient(180deg,#2f80ff,#1c63d8);border-color:rgba(78,161,255,.35)}
.badge{padding:8px 12px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);color:var(--muted);}
main{max-width:1200px;margin:0 auto;padding:18px 12px 90px;}
.card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:18px;box-shadow: 0 20px 60px rgba(0,0,0,.35);}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.meta{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
.stem{font-size:18px;line-height:1.65;margin:10px 0 14px;white-space:pre-wrap}
.choice{display:flex;gap:12px;align-items:flex-start;background:rgba(0,0,0,.14);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px 14px;margin:10px 0}
.choice:hover{border-color:rgba(255,255,255,.18)}
.choice .k{min-width:28px;height:28px;border-radius:10px;background:rgba(255,255,255,.06);display:flex;align-items:center;justify-content:center;color:var(--muted);font-weight:700}
.choice .t{line-height:1.55;white-space:pre-wrap}
.sep{height:1px;background:rgba(255,255,255,.08);margin:14px 0}
.footerbar{position:fixed;left:0;right:0;bottom:0;background:rgba(6,10,15,.78);backdrop-filter: blur(10px);border-top:1px solid rgba(255,255,255,.06);}
.footerbar .inner{max-width:1200px;margin:0 auto;padding:10px 12px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:space-between}
.small{font-size:12px;color:var(--muted)}
.panel{border:1px solid rgba(255,255,255,.10);border-radius:16px;padding:12px 14px;background:rgba(0,0,0,.18);white-space:pre-wrap}
.panel.good{border-color:rgba(82,210,125,.35)}
.panel.bad{border-color:rgba(255,90,107,.35)}
.hidden{display:none !important}
kbd{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);border-radius:8px;padding:2px 6px;font-size:12px}
/* Modal */
.modalMask{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:18px;z-index:50}
.modal{width:min(920px,100%);max-height:85vh;overflow:auto;background:linear-gradient(180deg,#0c1520,#070c12);border:1px solid rgba(255,255,255,.12);border-radius:18px;padding:14px;box-shadow:0 30px 90px rgba(0,0,0,.6)}
.modal .head{display:flex;gap:10px;align-items:center;justify-content:space-between;position:sticky;top:0;background:rgba(12,21,32,.92);backdrop-filter: blur(10px);padding:10px;border-radius:14px;border:1px solid rgba(255,255,255,.06)}
.modal .list{margin-top:10px}
.item{padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,.08);background:rgba(0,0,0,.14);margin:10px 0;cursor:pointer}
.item:hover{border-color:rgba(255,255,255,.18)}
.item .tt{font-weight:700}
.item .dd{color:var(--muted);margin-top:6px;white-space:pre-wrap}
/* ===== iPhone / small-screen tuning ===== */
:root{
  --safe-b: env(safe-area-inset-bottom);
  --safe-t: env(safe-area-inset-top);
  --safe-l: env(safe-area-inset-left);
  --safe-r: env(safe-area-inset-right);
}
/* iOS: prevent "tap highlight" glare */
*{ -webkit-tap-highlight-color: transparent; }
body{ padding-left: var(--safe-l); padding-right: var(--safe-r); }

main{ padding-bottom: calc(90px + var(--safe-b)); }

/* Bottom bar: avoid Home indicator overlap */
.footerbar{ padding-bottom: var(--safe-b); }
.footerbar .inner{ padding-bottom: calc(10px + var(--safe-b)); }

/* Small screens */
@media (max-width: 520px){
  html{ font-size:14px; } /* 全体を少しだけ縮める */
  header{ padding-top: var(--safe-t); }
  .topbar{ gap:8px; padding:8px 10px; }

  /* iOS zoom対策：inputは16px維持。ボタン類は小さく */
  input{ font-size:16px; }
  .sel,.btn{ font-size:13px; }

  .sel,.btn{ padding:8px 10px; border-radius:12px; }
  .badge{ padding:6px 8px; font-size:12px; }

  .stem{ font-size:14px; line-height:1.7; }
  .choice{ padding:10px 10px; }
  .choice .t{ font-size:14px; }

  /* ラジオ/チェックは少しだけ大きく（押しやすさ維持） */
  .choice input{ width:20px; height:20px; margin-top:2px; }

  .topbar{ flex-wrap:nowrap; overflow-x:auto; -webkit-overflow-scrolling:touch; }
  .topbar::-webkit-scrollbar{ display:none; }
  .footerbar .row{ flex-wrap:nowrap; overflow-x:auto; -webkit-overflow-scrolling:touch; }
  .footerbar .row::-webkit-scrollbar{ display:none; }

   main .card .row{ flex-wrap:wrap; }
   main .card .row .btn{ flex:1 1 45%; } /* 2列っぽく均等 */

  .card{ padding:14px; }
  .modal{ max-height: calc(85vh - var(--safe-b)); }
}

</style>
</head>
<body>
<header>
  <div class="topbar">
    <select id="chapterSel" class="sel"></select>
    <select id="modeSel" class="sel">
      <option value="normal">通常</option>
      <option value="random">ランダム</option>
    </select>
    <button id="glossBtn" class="btn">用語</button>
    <button id="histBtn" class="btn">履歴</button>
    <span id="statusBadge" class="badge">正解 0（回答済 0） / 0問</span>
  </div>
</header>

<main>
  <div class="card">
    <div class="meta">
      <span id="qTitle" class="badge">-</span>
      <span id="qType" class="badge">-</span>
      <span id="qState" class="badge">-</span>
    </div>

    <div id="qStem" class="stem">読み込み中...</div>

    <div id="choices"></div>

    <div class="sep"></div>

    <div class="row">
      <button id="judgeBtn" class="btn primary">判定</button>
      <button id="toggleExplainBtn" class="btn">解説を表示</button>
      <button id="prevBtn" class="btn">前へ</button>
      <button id="nextBtn" class="btn">次へ</button>
    </div>

    <div id="resultPanel" class="panel hidden" style="margin-top:12px"></div>
    <div id="answerPanel" class="panel hidden" style="margin-top:12px"></div>

    <div class="small" style="margin-top:10px">
      ショートカット： <kbd>←</kbd>/<kbd>→</kbd> 移動、<kbd>J</kbd> 判定、<kbd>E</kbd> 解説、<kbd>G</kbd> 用語、<kbd>H</kbd> 履歴
    </div>
  </div>
</main>

<div class="footerbar">
  <div class="inner">
    <div class="row">
      <button id="topBtn" class="btn">先頭へ</button>
      <button id="wrongFilterBtn" class="btn">×だけ（フィルタ）</button>
      <button id="unansweredFilterBtn" class="btn">未回答だけ（フィルタ）</button>
      <button id="clearFilterBtn" class="btn">フィルタ解除</button>
    </div>
    <div class="small">※ 状態はブラウザに保存（localStorage）</div>
  </div>
</div>

<!-- Glossary Modal -->
<div id="glossMask" class="modalMask">
  <div class="modal">
    <div class="head">
      <div class="row">
        <span class="badge">用語（牽引）</span>
        <input id="glossSearch" class="sel" style="width:min(420px,100%)" placeholder="検索（例：EC2）"/>
      </div>
      <button class="btn" id="glossClose">閉じる</button>
    </div>
    <div id="glossList" class="list"></div>
  </div>
</div>

<!-- History Modal -->
<div id="histMask" class="modalMask">
  <div class="modal">
    <div class="head">
      <div class="row">
        <span class="badge">履歴一覧</span>
        <select id="histFilter" class="sel">
          <option value="all">すべて</option>
          <option value="unanswered">未回答</option>
          <option value="wrong">×のみ</option>
          <option value="correct">○のみ</option>
          <option value="answered">回答済</option>
        </select>
        <input id="histSearch" class="sel" style="width:min(420px,100%)" placeholder="検索（問題文の一部）"/>
      </div>
      <button class="btn" id="histClose">閉じる</button>
    </div>
    <div id="histList" class="list"></div>
  </div>
</div>


<!-- 外部JSON専用版: questions.json / glossary.json を同フォルダに置いてください -->

<script>
// --- iOS Safari / private mode safe storage wrapper ---
const _storage = (()=>{
  try {
    const k = "__aws_quiz_test__";
    window.localStorage.setItem(k, "1");
    window.localStorage.removeItem(k);
    return window.localStorage;
  } catch (e) {
    const mem = Object.create(null);
    return {
      getItem: (key) => (key in mem ? mem[key] : null),
      setItem: (key, val) => { mem[key] = String(val); },
      removeItem: (key) => { delete mem[key]; },
    };
  }
})();
const lsGet = (k) => _storage.getItem(k);
const lsSet = (k, v) => _storage.setItem(k, v);
const lsDel = (k) => _storage.removeItem(k);


let QUESTIONS = [];
let GLOSSARY = [];

// 外部JSON専用：同フォルダの questions.json / glossary.json を fetch で読み込みます。
// ※ file:// 直開きだと fetch が失敗することがあります。確実に動かすにはローカルサーバ推奨（例: python -m http.server）
async function loadJson(url){
  const r = await fetch(url, { cache: "no-store" });
  if(!r.ok) throw new Error(`${url}: HTTP ${r.status}`);
  return await r.json();
}

// --- data fix: infer missing answers from explanation (e.g., "答え‥A、D")
function inferMissingAnswers(){
  const re = /答え\s*[\.．…‥・]*\s*[:：]?\s*([A-EＡ-Ｅ][A-EＡ-Ｅ\s,、・\/]*)(?:\n|$)/;
  for (const q of QUESTIONS){
    if (Array.isArray(q.answer) && q.answer.length > 0) continue;
    const exp = (q.explanation || q.explain || "").trim();
    if (!exp) continue;
    const m = exp.match(re);
    if (!m) continue;
    const letters = (m[1] || "").toUpperCase().match(/[A-E]/g) || [];
    const uniq = Array.from(new Set(letters));
    if (uniq.length === 0) continue;
    q.answer = uniq;
    if (!q.multi && uniq.length > 1) q.multi = true;
    if (!q.required || q.required < 1) q.required = 1;
    if (uniq.length > 1 && q.required === 1) q.required = uniq.length;
  }
}

const LS_KEY = "aws_quiz_attempts_v1";

let attempts = loadAttempts();
let chapterSel = document.getElementById("chapterSel");
let modeSel = document.getElementById("modeSel");
let statusBadge = document.getElementById("statusBadge");

let qIndex = 0;
let activeList = [];
let wrongOnly = false;
let unansweredOnly = false;

let showExplain = false;

function el(id){ return document.getElementById(id); }

function stripLeak(s) {
  if (!s) return "";
  return s.split(/\n/).filter(line => !/^\s*第\s*\d+\s*章/.test(line.trim())).join("\n").trim();
}

function loadAttempts() {
  try {
    const raw = lsGet(LS_KEY);
    if (!raw) return {};
    return JSON.parse(raw);
  } catch(e) {
    return {};
  }
}
function saveAttempts() {
  try { lsSet(LS_KEY, JSON.stringify(attempts)); } catch(e) {}
}

function buildChapterOptions() {
  const chs = Array.from(new Set(QUESTIONS.map(q=>q.chapter))).sort((a,b)=>a-b);
  chapterSel.innerHTML = "";
  const optAll = document.createElement("option");
  optAll.value = "0"; optAll.textContent = "全章";
  chapterSel.appendChild(optAll);
  for (const ch of chs) {
    const o = document.createElement("option");
    o.value = String(ch);
    o.textContent = (Number(ch)===999) ? "独自問題" : `第${ch}章`;
    chapterSel.appendChild(o);
  }
}

function getBaseList() {
  const ch = parseInt(chapterSel.value,10);
  let base = QUESTIONS.slice();
  if (ch && !isNaN(ch)) base = base.filter(q=>q.chapter===ch);
  base.sort((a,b)=> (a.chapter-b.chapter) || (a.qnum-b.qnum));
  return base;
}

function shuffle(arr) {
  const a = arr.slice();
  for (let i=a.length-1;i>0;i--) {
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

function applyMode() {
  const mode = modeSel.value;
  // 基本リスト（左プルダウン：全章 or 章指定）を取得
  let list = getBaseList();

  // 並び順（通常 / ランダム）
  if (mode === "random") {
    list = shuffle(list);
  } else {
    // "normal" は getBaseList() が章→問番号でソート済み
  }

  // 下部フィルタ（×だけ / 未回答だけ）
  if (wrongOnly) {
    list = list.filter(q => attempts[q.id] && attempts[q.id].answered && attempts[q.id].correct === false);
  }
  if (unansweredOnly) {
    list = list.filter(q => !attempts[q.id] || !attempts[q.id].answered);
  }

  activeList = list;
  if (qIndex >= activeList.length) qIndex = Math.max(0, activeList.length - 1);
  updateStatus();
  render();
}

function updateStatus() {
  const total = activeList.length;
  let answered=0, correct=0;
  for (const q of activeList) {
    const a = attempts[q.id];
    if (a && a.answered) {
      answered++;
      if (a.correct) correct++;
    }
  }
  statusBadge.textContent = `正解 ${correct}（回答済 ${answered}） / ${total}問`;
}

function setPanelsHidden() {
  showExplain = false;
  el("answerPanel").classList.add("hidden");
  el("resultPanel").classList.add("hidden");
  el("toggleExplainBtn").textContent = "解説を表示";
}

function render() {
  if (!activeList.length) {
    el("qTitle").textContent = "表示対象なし";
    el("qType").textContent = "-";
    el("qState").textContent = "-";
    el("qStem").textContent = "表示対象の問題がありません。フィルタを解除するかモードを変更してください。";
    el("choices").innerHTML = "";
    setPanelsHidden();
    return;
  }
  const q = activeList[qIndex];

  const a = attempts[q.id];
  const answered = a && a.answered;
  const correct = answered ? a.correct : null;

  const chLabel = (Number(q.chapter)===999) ? "独自問題" : `第${q.chapter}章`;
  el("qTitle").textContent = `${chLabel} / 練習問題${q.qnum}`;
  el("qType").textContent = q.multi ? `複数選択（${q.required}つ）` : "単一選択";
  el("qState").textContent = !answered ? "未回答" : (correct ? "○ 正解" : "× 不正解");

  el("qStem").textContent = stripLeak(q.stem);

  const box = el("choices");
  box.innerHTML = "";
  const selected = (a && Array.isArray(a.selected)) ? a.selected : [];
  for (const c of q.choices) {
    const row = document.createElement("div");
    row.className = "choice";
    const inp = document.createElement("input");
    inp.type = q.multi ? "checkbox" : "radio";
    inp.name = "choice";
    inp.value = c.key;
    inp.checked = selected.includes(c.key);
    inp.addEventListener("change", ()=>onSelect(q, inp.value, inp.checked));
    const k = document.createElement("div");
    k.className = "k";
    k.textContent = c.key;
    const t = document.createElement("div");
    t.className = "t";
    t.textContent = stripLeak(c.text);
    row.appendChild(inp);
    row.appendChild(k);
    row.appendChild(t);
    box.appendChild(row);
  }

  setPanelsHidden();
}

function onSelect(q, key, checked) {
  let a = attempts[q.id] || {selected:[], answered:false, correct:false};
  let sel = Array.isArray(a.selected) ? a.selected.slice() : [];
  if (q.multi) {
    if (checked) {
      if (!sel.includes(key)) sel.push(key);
    } else {
      sel = sel.filter(x=>x!==key);
    }
  } else {
    sel = [key];
  }
  a.selected = sel;
  attempts[q.id] = a;
  saveAttempts();
}

function judge() {
  if (!activeList.length) return;
  const q = activeList[qIndex];
  const a = attempts[q.id] || {selected:[], answered:false, correct:false};
  const sel = Array.isArray(a.selected) ? a.selected.slice() : [];
  const ans = Array.isArray(q.answer) ? q.answer.slice() : [];
  let ok = false;

  if (!ans.length) {
    ok = false;
  } else {
    const s1 = sel.slice().sort().join(",");
    const s2 = ans.slice().sort().join(",");
    ok = (s1===s2);
  }
  a.answered = true;
  a.correct = ok;
  a.answeredAt = Date.now();
  attempts[q.id] = a;
  saveAttempts();
  updateStatus();

  const panel = el("resultPanel");
  panel.classList.remove("hidden");
  panel.classList.toggle("good", ok);
  panel.classList.toggle("bad", !ok);
  const ansStr = ans.length ? ans.join(",") : "（未登録）";
  panel.textContent = ok ? `○ 正解　あなた: ${sel.join(",") || "（未選択）"} / 正解: ${ansStr}`
                         : `× 不正解　あなた: ${sel.join(",") || "（未選択）"} / 正解: ${ansStr}`;

  el("qState").textContent = ok ? "○ 正解" : "× 不正解";
}

function toggleExplain() {
  if (!activeList.length) return;
  const q = activeList[qIndex];
  showExplain = !showExplain;
  const p = el("answerPanel");

  if (!showExplain) {
    p.classList.add("hidden");
    el("toggleExplainBtn").textContent = "解説を表示";
    return;
  }

  el("toggleExplainBtn").textContent = "解説を隠す";
  p.classList.remove("hidden");
  const ansStr = (q.answer && q.answer.length) ? q.answer.join(",") : "（未登録）";
  const exp = stripLeak(q.explanation || "（解説なし）");
  p.textContent = `正解： ${ansStr}\n\n${exp}`;
}
function go(delta) {
  if (!activeList.length) return;
  qIndex = Math.max(0, Math.min(activeList.length-1, qIndex + delta));
  render();
}

function openGloss() {
  el("glossMask").style.display="flex";
  renderGloss();
  el("glossSearch").focus();
}
function closeGloss() { el("glossMask").style.display="none"; }
function renderGloss() {
  const q = el("glossSearch").value.trim().toLowerCase();
  const list = el("glossList");
  list.innerHTML="";
  const items = GLOSSARY.filter(e=> !q || e.term.toLowerCase().includes(q) || (e.desc||"").toLowerCase().includes(q));
  for (const it of items) {
    const div=document.createElement("div");
    div.className="item";
    const t=document.createElement("div"); t.className="tt"; t.textContent=it.term;
    const d=document.createElement("div"); d.className="dd"; d.textContent=it.desc;
    div.appendChild(t); div.appendChild(d);
    list.appendChild(div);
  }
  if (!items.length) {
    const div=document.createElement("div");
    div.className="item";
    div.textContent="該当なし";
    list.appendChild(div);
  }
}

function openHist() {
  el("histMask").style.display="flex";
  renderHist();
  el("histSearch").focus();
}
function closeHist() { el("histMask").style.display="none"; }
function renderHist() {
  const f = el("histFilter").value;
  const q = el("histSearch").value.trim();
  const list=el("histList");
  list.innerHTML="";
  const items = activeList.filter(qq=> {
    const a=attempts[qq.id];
    const answered=a && a.answered;
    const ok=answered && a.correct===true;
    const ng=answered && a.correct===false;
    if (f==="unanswered" && answered) return false;
    if (f==="wrong" && !ng) return false;
    if (f==="correct" && !ok) return false;
    if (f==="answered" && !answered) return false;
    if (q) {
      const hay = `${qq.chapter}章 練習問題${qq.qnum}\n${qq.stem}`.toLowerCase();
      if (!hay.includes(q.toLowerCase())) return false;
    }
    return true;
  });
  for (const it of items) {
    const a=attempts[it.id];
    const answered=a && a.answered;
    const tag = !answered ? "未回答" : (a.correct ? "○" : "×");
    const div=document.createElement("div");
    div.className="item";
    div.addEventListener("click", ()=>{
      const idx = activeList.findIndex(x=>x.id===it.id);
      if (idx>=0) {
        qIndex=idx;
        closeHist();
        render();
      }
    });
    const t=document.createElement("div"); t.className="tt"; t.textContent=`[${tag}] 第${it.chapter}章 / 練習問題${it.qnum}`;
    const d=document.createElement("div"); d.className="dd"; d.textContent=stripLeak(it.stem).slice(0,160);
    div.appendChild(t); div.appendChild(d);
    list.appendChild(div);
  }
  if (!items.length) {
    const div=document.createElement("div");
    div.className="item";
    div.textContent="該当なし（フィルタ/検索条件を見直してください）";
    list.appendChild(div);
  }
}

// events
chapterSel.addEventListener("change", ()=>{ qIndex=0; applyMode(); });
modeSel.addEventListener("change", ()=>{ qIndex=0; applyMode(); });

el("judgeBtn").addEventListener("click", judge);
el("toggleExplainBtn").addEventListener("click", toggleExplain);
el("prevBtn").addEventListener("click", ()=>go(-1));
el("nextBtn").addEventListener("click", ()=>go(1));
el("topBtn").addEventListener("click", ()=>{ qIndex=0; render(); });

el("wrongFilterBtn").addEventListener("click", ()=>{ wrongOnly=true; unansweredOnly=false; qIndex=0; applyMode(); });
el("unansweredFilterBtn").addEventListener("click", ()=>{ unansweredOnly=true; wrongOnly=false; qIndex=0; applyMode(); });
el("clearFilterBtn").addEventListener("click", ()=>{ wrongOnly=false; unansweredOnly=false; qIndex=0; applyMode(); });

el("glossBtn").addEventListener("click", openGloss);
el("glossClose").addEventListener("click", closeGloss);
el("glossMask").addEventListener("click", (e)=>{ if(e.target.id==="glossMask") closeGloss(); });
el("glossSearch").addEventListener("input", renderGloss);

el("histBtn").addEventListener("click", openHist);
el("histClose").addEventListener("click", closeHist);
el("histMask").addEventListener("click", (e)=>{ if(e.target.id==="histMask") closeHist(); });
el("histFilter").addEventListener("change", renderHist);
el("histSearch").addEventListener("input", renderHist);

// shortcuts
document.addEventListener("keydown",(e)=>{
  if (e.key==="ArrowRight") { go(1); }
  else if (e.key==="ArrowLeft") { go(-1); }
  else if (e.key.toLowerCase()==="j") { judge(); }
  else if (e.key.toLowerCase()==="e") { toggleExplain(); }
  else if (e.key.toLowerCase()==="g") { openGloss(); }
  else if (e.key.toLowerCase()==="h") { openHist(); }
});


async function init() {
  try{
    QUESTIONS = await loadJson("questions.json");
    GLOSSARY  = await loadJson("glossary.json");
  }catch(e){
    console.error(e);
    alert("questions.json / glossary.json の読み込みに失敗しました。\n\n・同じフォルダに配置されているか\n・file://直開きの場合はローカルサーバで開いているか（推奨: python -m http.server）\n\n詳細: " + (e && e.message ? e.message : e));
    // 最低限の表示
    QUESTIONS = [];
    GLOSSARY = [];
  }

  inferMissingAnswers();

  buildChapterOptions();
  chapterSel.value = lsGet("aws_quiz_chapter_sel") || "0";
  modeSel.value = lsGet("aws_quiz_mode_sel") || "normal";
  chapterSel.addEventListener("change", ()=>lsSet("aws_quiz_chapter_sel", chapterSel.value));
  modeSel.addEventListener("change", ()=>lsSet("aws_quiz_mode_sel", modeSel.value));
  applyMode();
}
init();

</script>
</body>
</html>